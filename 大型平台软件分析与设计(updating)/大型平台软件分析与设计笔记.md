# Introduction

平时 50% (出勤率 + 响应率 + 答辩贡献权值 + 组内积极性) 小组成绩*个人系数
测验 50% (5道大题 架构分析+架构设计)

TL：记录成员关键指标，绩效排序；准备答辩材料分工、协作；提高团队响应率、出勤率。

![image-20230312163052434](大型平台软件分析与设计笔记.assets/image-20230312163052434.png)

![image-20230312163230287](大型平台软件分析与设计笔记.assets/image-20230312163230287.png)![image-20230312163852149](大型平台软件分析与设计笔记.assets/image-20230312163852149.png)

![image-20230312164139141](大型平台软件分析与设计笔记.assets/image-20230312164139141.png)

![image-20230312164410294](大型平台软件分析与设计笔记.assets/image-20230312164410294.png)

# 大型平台概述

- 高并发，高可用
- 数据量大
- 用户分布广泛，基数大，网络情况复杂
- 随用户需求持续跌打
- 有时间和技术的沉淀，渐进式发展
- 安全环境恶劣

## 平台架构

平台架构是针对平台设计及演进过程中所有关键问题的解决方案总和。

架构就是一切从实际出发，解决已发生，或者大概率即将会遇到的问题。

## 基本概念介绍

### 分布式架构

相对于单体架构或者集中式架构而言，将相同或不同的功能模块运行在**不同的机器**上，互相之间**通过网络通信**
**高性价比**相对于单体架构难以解决的问题

### 微服务架构

将单一应用程序划分为一组小的服务，服务之间相互协调配合，采用轻量级的通讯协议沟通。每个服务都围绕着具体的业务进行构建，并且能够被独立的部署到生产环境

对于传统服务的区别

> 优点:
>
> 1. 研发成本低
> 2. 本地性能好
> 3. 没有分布式的管理和调用小号
>
> 缺点:
>
> 1. 多版本并行效率低
> 2. 随业务发展越发庞大，迁一处动全身
> 3. 上手成本高，坑多
> 4. 稳定性差，代码模块莫名受牵连
> 5. 瓶颈低

### 微服务基于分布式做了什么

1. 网络层协议标准化
2. 数据层协议标准化
3. 网络开发框架标准化
4. 统一服务注册与发现机制
5. 全链路分布式追踪
6. 统一限流、熔断、降级、服务监控体系等等

## 大型平台的质量

- 性能

  - 衡量指标：响应时间、并发数、吞吐量

  - 响应时间：从请求发出到收到响应的时间

  - 并发数：平台用户数->平台在线用户数->网络并发用户数

  - 吞吐量: TPS(每秒事务数)，HPS(每秒HTTP请求数)， QPS(每秒查询数)，访问数/天，业务数/小时

  - 性能优化策略

    > - web前端性能优化
    >   - 浏览器访问优化
    >   - CDN
    >   - 反向代理
    > - 应用服务器性能优化
    >   - 负载均衡
    >   - 分布式
    >   - 集群
    >   - 缓存
    >   - 异步
    > - 存储性能优化
    >   - 主从分离
    >   - 分布式存储

- 可用性

  - 衡量指标：一台或多台服务器宕机，系统仍然可用。目标就是达到7*24可用，常用几个9来衡量，四个9指全年99.99%时间可用

  - 可用性优化策略

    > - 

- 伸缩性

  - 衡量标准：是否可以用多台服务器构建集群，能否向集群中增减服务器，增减服务器之后是否能保证像原来一样可用。让服务“无状态”

  - 伸缩性优化策略

    > 总的来说，有状态服务和无状态服务各有优缺点，选择哪种类型的服务应该根据具体应用场景和需求来确定。例如，需要维护用户登录状态的应用程序可能需要有状态服务，而具有大量请求并需要高度扩展性的应用程序可能更适合使用无状态服务。

- 拓展性

  - 衡量标准：增加新的业务流程时，或基于已有业务流程扩展时，是否可以实现对现有业务透明无影响

  - 拓展性优化策略

    > - 抽象可复用的基础服务，做好封装
    > - 松耦合设计
    > - 基于业务和技术的发展预见性设计

- 安全性

  - 衡量标准：对攻击与窃密手段，是否有应对策略

好的架构要看具体需求、成本

# 分布式架构

## 分布式系统概述

相对于单体架构或者集中式架构而言，将相同或不同的功能模块运行在**不同的机器**上，互相之间**通过网络通信**

### 分布式系统特点

- 分布性
- 对等性
- 并发性
- 全局时钟
- 故障总是发生

### 分布式面临的经典问题

- 高并发的分片策略、异步化任务调度等
- 分布式场景下，数据一致性
- 数据分区或多副本场景下数据一致性问题
- 多结点的不稳定、容灾等问题
- 高并发时的数据预期问题

### TiDB核心特性

- 水平拓展
  计算能力和存储能力
- 高可用
  TiDB/TiKv/PD三个组件都能容忍部分实例失效

### Kafka

消息系统，使用推拉模型将生产者和消费者分离

#### 副本

副本保证高可用，不会等全部副本，部分副本可用

#### 分区

分区保证消费高并发

## CAP经典理论

一个分布式系统不可能同时满足

- 一致性(Consistency)
- 可用性(Availability)
- 分区容错性(Partition tolerance)

这三个基本需求

### 一致性

数据的多个副本间能否保持一致的特性

> 针对某一数据项的修改成功后，可使所有用户或业务场景立刻读取或感知到最新的值，则该系统可以认为具有强一致性

### 可用性

系统提供的服务必须一直处于可用的状态，对于用户的所有请求都能够在"有限的时间"内"返回结果"

### 分区容错性

系统遇到网络分区故障的时候，需要能够保证对外提供满足一致性和可用性的服务，除非整个网络环境都发生了故障

<img src="大型平台软件分析与设计笔记.assets/image-20230326163242532.png" alt="image-20230326163242532" style="zoom:67%;" />

## 高并发

### 读

**读写分离**

- 动静分离与CND加速
- 加缓存
  - 缓存雪崩
  - 缓存击穿
  - 大量的热Key过期
- 异步化
- 转批量(预读)
- **重写轻读**

<img src="大型平台软件分析与设计笔记.assets/image-20230326164848125.png" alt="image-20230326164848125" style="zoom: 50%;" />

<img src="大型平台软件分析与设计笔记.assets/image-20230326165109852.png" alt="image-20230326165109852" style="zoom: 67%;" />

<img src="大型平台软件分析与设计笔记.assets/image-20230326165258943.png" alt="image-20230326165258943" style="zoom:67%;" />

### 写

- 数据分片
  DB的分库分表，JDK的currentHashMap、kafka的分区
- 任务分片
  多线程、桂明思路(map\reduce)
- 异步化(LSM树 log structed tree)
  **LSM树**存储的有序的，又能高效写，有日志，然后用内存来排序，最后异步写进磁盘
  <img src="大型平台软件分析与设计笔记.assets/image-20230326165947689.png" alt="image-20230326165947689" style="zoom:50%;" />
- 转批量

<img src="大型平台软件分析与设计笔记.assets/image-20230326170257375.png" alt="image-20230326170257375" style="zoom:67%;" />

**消息队列缓冲，削峰**

<img src="大型平台软件分析与设计笔记.assets/image-20230326170749780.png" alt="image-20230326170749780" style="zoom:67%;" />

<img src="大型平台软件分析与设计笔记.assets/image-20230326172117099.png" alt="image-20230326172117099" style="zoom:67%;" />

<img src="大型平台软件分析与设计笔记.assets/image-20230326172221058.png" alt="image-20230326172221058" style="zoom:67%;" />

<img src="大型平台软件分析与设计笔记.assets/image-20230326172530914.png" alt="image-20230326172530914" style="zoom:67%;" />

**及时止损**
资质双写双读策略——采用DFS存储备份，同步备份，实时补救的，巡检+监控

### 读写设计原理

**常用基本概念：吞吐量、响应时间、并发数**
吞吐量：单位时间内可处理的请求数量，QPS、TPS
响应时间：处理每个请求所需时间。TP95、TP99
并发数：服务器能同时处理的请求个数。

`吞吐量 × 响应时间 = 并发数(单CPU)`

**并行系统复杂的多**<img src="大型平台软件分析与设计笔记.assets/image-20230326173129651.png" alt="image-20230326173129651" style="zoom:67%;" />

`机器数 = 总请求预估/单机能承载的最大请求`
总请求按照场景去平均值和峰值

> **如何去估计QPS**
>
> - 利用IO和CPU耗时比例估算
>
>   200ms = 30ms (cpu) + 120ms (IO) + 50ms (内存)
>   充分利用cpu的方法：开多线程、异步IO
>
> - 压力测试
>   准备好环境
>   核心读写接口压力测试
>   全链路压力测试与单机压力

**限流**：通过限制单位时间内请求次数的方式来实现保护服务应用的一种策略

> **单机限流**：
>
> - 有界的任务队列
> - 令牌桶算法
> - 漏桶算法
>
> <img src="大型平台软件分析与设计笔记.assets/image-20230326174006235.png" alt="image-20230326174006235" style="zoom: 67%;" />
>
> **中央限流**：用来控制总流量

**熔断与降级**
熔断一般是服务调用者对自我体系的保护机制

> - 基于请求失败率为基准做熔断策略
> - 基于请求耗时为基准做熔断策略

降级往往是服务调用者为了保证自身核心服务和数据的稳定，对非核心功能和流程采取的"忽略"行为

> 降级不单单是接口请求级别的降级，也可以是功能主动降级和服务主动降级
>
> 比如在大促前夜，为了降低DB读写压力，会主动关闭评论相关功能，以保证下单交易的顺利进行

**请求重试**



## 高可用



## 分布式事务



# 业务架构与微服务架构



# 云原生



# 实验与答辩:系统架构设计